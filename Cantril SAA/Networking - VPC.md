#networking #vpc 

- CIDR
	- method for allocating IP addresses
	- Used in Security Groups rules and AWS networking in general
	- defines an IP address range
	- Has two components
		- Base IP
			- Contained in the range
		- Subnet Mask
			- Defines how many bits can change in IP
			- /0, /24, /32
	- Subnet Mask
		- The lower the subnet number we have more IP addresses in the range
		- /0 allows for all IPs
- Public vs Private IP
	- The IANA established blocks of IPs only used for Public and Private
	- Private IP can only allow certain values
- VPC in AWS
	- VPC = Virtual Private Cloud
	- Can have multiple VPCs in an AWS region (max 5 per region soft limit)
	- Max CIDR per VPC is 5 for each CIDR
		- Min size /28
		- Max size /16
	- VPC is private, only private IPv4 ranges allowed
	- YOUR VPC CIDR SHOULD NOT OVERLAP WITH YOUR OTHER NETWORKS
- VPC - Subnet (IPv4)
	- AWS reserves 5 IP addresses (first 4 & last 1) in each subnet
- Internet Gateway (IGW)
	- Allow resources in a VPC to connect to the internet
	- Scales horizontally, highly available, and redundant
	- Must be created separately from a VPC
	- One VPC can only be attached to one IGW and vice versa
	- Internet gateways on their own do not allow internet access
	- Route tables must also be edited
- Bastion Hosts
	- EC2 Instance in the Public Subnet (Bastion Host)
	- We can use the Bastion Host to SSH into private EC2 instances
	- Is connected to all other private subnets
	- Bastion Host security group must allow access from the internet
		- Access from the public CIDR from your corporation for example
	- Security Group of the EC2 Instances must allow the Security Group of the Bastion Host or the private IP of the Bastion host
- NAT Instance
	- Outdated but still on exam
	- Network Address Translation
	- Allows EC2s in the private subnets to connect to the internet
	- Must be launched in a public subnet
	- Must disable EC2 setting: Source / destination Check
	- Must have Elastic IP attached to it
	- Route tables must be made to route traffic from private subnets to the NAT Instance
- NAT Gateway
	- AWS-managed NAT
	- Pay per hour
	- NATGW created in specific AZ, uses Elastic IP
	- Requires an IGW (Private Subnet => NATGW => IGW)
	- 5 Gbps of bandwidth with automatic scaling up to 100 Gbps
	- No security groups required
- NAT Gateway with High Availability
	- resilient within a single AZ
	- must create multiple NAT Gateways in multiple AZs for fault-tolerance
	- There is no cross-AZ failover needed because if an AZ goes down it doesn't need NAT
- Security Groups & NACLs
	- like a firewall which control traffic and to subnets
	- One NACL per subnet
	- New subnets assigned the default NACL
	- NACL Rules
		- Rules have a number, higher precedence with a lower number
		- First rule match will drive the decision
		- The last rule is an a (*) and denies a request if none of the rules match
		- AWS recommends adding rules by increment 100
	- Newly created NACLs will deny everything
	- NACL are a great way of blocking a specific IP address at the subnet level
- Default NACL
	- Accepts everything inbound/outbound with the subnets it's associated with
	- Do not modify, create custom NACLs
- Ephemeral Ports
	- for two endpoints to establish a connection they must use ports
	- Clients connect to a defined port, and expect a response on an ephemeral port
	- Different Operating Systems use different port ranges
- NACL with Ephemeral Ports
- VPC Peering
	- Privately connect two VPCs using AWS network
	- Make them behave as if they were in the same network
	- Must not have overlapping CIDRs
	- VPC Peering connection is NOT transitive
	- You must update route tables in each VPC's subnets to ensure EC2 instances can communicate with each other
	- can create connections in different AWS accounts/regions
	- can reference a security group in a peered VPC (works across accounts -same region)
- VPC Endpoints (AWS PrivateLink)
	- Every AWS service is publicly exposed
	- VPC Endpoints allows you to connect to AWS services using a private network instead of using the public Internet
	- redundant and scale horizontally
	- remove the need of IGW, NATGW to access AWS Services
	- If issues
		- Check DNS Setting Resolution
		- Check Route Tables
- Types of Endpoints
	- Interface Endpoints (powered by PrivateLink)
		- Uses an ENI (private IP address) as an entry point (must attach a Security Group)
		- Supports most AWS services
		- $ per hour and $ per GB of data processed
	- Gateway Endpoints
		- Provisions a gateway and must be used as a target in a route table (does not use security groups)
		- Supports both S3 and DynamoDB
		- Free
		- Gateway is most likely going to be preferred all the time at the exam
			- It's free
			- Interface endpoint is preferred for on-premises, a different VPC, or a different region
- VPC Flow Logs
	- Capture information about IP traffic going into your interfaces
		- VPC Flow Logs
		- Subnet Flow Logs
		- Elastic Network Interface (ENI) Flow Logs
	- Helps monitor & troubleshoot connectivity issues
	- Flow logs data can go to S3, CloudWatch Logs, and Kinesis Data Firehouse
	- Captures network information from AWS managed interfaces too: ELB, RDS, ElastiCache, Redshift, WorkSpaces, NATGW, Transit Gateway
- VPC Flow Logs Syntax
	- srcaddr & dstaddr - help identify problematic IP
	- srcport & dstport - help identify problematic ports
	- Action - success or failure of the request due to Security Group / NACL
	- Can be used for analytics on usage patterns or malicious behavior
	- Query VPC flow logs using Athena on S3 or CloudWatch Logs Insights
- VPC Flow Logs - Troubleshoot SG & NACL issues
	- Look at the "Action" field
	- Incoming Requests
		- Inbound REJECT => NACL or SG
		- Inbound ACCEPT, Outbound REJECT => NACL
	- Outgoing Requests
		- Outbound REJECT => NACL or SG
		- Outbound ACCEPT, Inbound REJECT => NACL